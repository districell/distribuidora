<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Admin • Cell Distribuciones</title>
<style>
:root{--max:1100px;--green:#2ecc71;--border:#e5e5e5}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:#fafafa;color:#111}
header{background:#111;color:#fff;padding:12px}
.wrap{max-width:var(--max);margin:0 auto;display:flex;align-items:center;justify-content:space-between}
.main{max-width:var(--max);margin:16px auto;padding:0 12px}
.panel{background:#fff;border:1px solid var(--border);border-radius:10px;padding:12px;margin-bottom:12px}
.btn{padding:8px 12px;border:none;border-radius:8px;background:#111;color:#fff;cursor:pointer}
.btn.green{background:#2ecc71}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px}
.card{border:1px solid var(--border);border-radius:10px;padding:10px;background:#fff}
.small{font-size:12px;color:#666}
.login{max-width:420px;margin:40px auto;padding:12px;background:#fff;border-radius:10px;border:1px solid var(--border)}
input,select,textarea{width:100%;padding:8px;border:1px solid var(--border);border-radius:8px}
.preview{height:150px;background:#f1f1f1;border-radius:8px;display:flex;align-items:center;justify-content:center;overflow:hidden}
.preview img{max-width:100%;max-height:100%}
.row{display:flex;gap:8px;flex-wrap:wrap}
.cat-box{padding:8px;border:1px solid var(--border);border-radius:8px;background:#fff;display:flex;gap:8px;align-items:center}
.small-input{width:90px;padding:6px}
.right{margin-left:auto}
.note{font-size:12px;color:#666;margin-top:6px}

/* Modal flotante */
.modal-bg {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.6);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 999;
}
.modal {
  background: #fff;
  padding: 20px;
  border-radius: 10px;
  max-width: 700px;
  width: 100%;
}
.modal h3 {margin-top:0}
.footer-row{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <img src="logo.png" alt="Cell Distribuciones" style="height:28px;vertical-align:middle;">
    <div>
      <button id="logout" class="btn">Salir</button>
    </div>
  </div>
</header>

<main class="main">

  <!-- LOGIN (sin mostrar credenciales ni demo) -->
  <div id="loginBox" class="login">
    <h3>Ingresar</h3>
    <input id="email" placeholder="Email">
    <input id="pass" placeholder="Contraseña" type="password">
    <div style="margin-top:8px;display:flex;gap:8px">
      <button id="doLogin" class="btn green">Entrar</button>
    </div>
  </div>

  <!-- TOKEN (opcional) -->
  <div id="tokenBox" class="login" style="display:none">
    <h3>Token de GitHub</h3>
    <p class="small">Pegá tu token con permiso <b>public_repo</b>. Se guarda localmente.</p>
    <input id="ghToken" placeholder="ghp_xxx..." autocomplete="off"><br><br>
    <button id="saveToken" class="btn green">Guardar Token</button>
  </div>

  <!-- APP -->
  <div id="app" style="display:none">
    <div class="panel">
      <h3>Categorías</h3>
      <div class="row" style="margin-bottom:8px">
        <input id="newCat" placeholder="Nueva categoría">
        <input id="newMarkup" class="small-input" placeholder="% markup" type="number" step="1">
        <button id="addCat" class="btn">Agregar</button>
        <div class="right">
          <button id="showAll" class="btn">Ver Todas</button>
        </div>
      </div>
      <div id="cats" class="row small" style="margin-top:8px"></div>
    </div>

    <div class="panel">
      <h3>Productos</h3>
      <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
        <input id="q" placeholder="Buscar...">
        <button id="addProductBtn" class="btn green">Agregar producto</button>
        <div class="right">
          <button id="exportBtn" class="btn">Export JSON</button>
          <button id="importBtn" class="btn">Import JSON</button>
          <input id="importFile" type="file" accept=".json" style="display:none">
        </div>
      </div>
      <div id="list" class="grid" style="margin-top:10px"></div>
    </div>
  </div>

</main>

<!-- MODAL -->
<div id="modalBg" class="modal-bg">
  <div class="modal">
    <h3 id="modalTitle">Editar producto</h3>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
      <div>
        <label class="small">ID</label>
        <input id="pId" placeholder="ID" readonly>
      </div>
      <div>
        <label class="small">Categoría</label>
        <select id="pCat"></select>
      </div>
      <div style="grid-column:1/3">
        <label class="small">Nombre</label>
        <input id="pNombre" placeholder="Nombre">
      </div>
      <div>
        <label class="small">Precio base</label>
        <input id="pPrecio" placeholder="0.00" type="number" step="0.01">
      </div>
      <div>
        <label class="small">Stock / Info</label>
        <input id="pStock" placeholder="Stock, codigo, etc">
      </div>
      <div style="grid-column:1/3">
        <label class="small">Características</label>
        <textarea id="pSpecs" rows="4" placeholder="Características"></textarea>
      </div>
      <div>
        <label class="small">Imagen</label>
        <input id="pImagen" type="file" accept="image/*">
      </div>
      <div>
        <label class="small">Preview</label>
        <div id="pPreview" class="preview">Sin imagen</div>
      </div>
    </div>

    <div class="footer-row">
      <button id="deleteProduct" class="btn" style="background:#c0392b">Eliminar</button>
      <button id="closeModal" class="btn">Cerrar</button>
      <button id="save" class="btn green">Guardar</button>
    </div>
  </div>
</div>

<script>
/* -- Misma lógica que teníamos, pero sin mostrar credenciales ni Demo.
   Copié la versión estable y sólo quité la sugerencia visible y el Demo. */

/* Config GitHub (opcional) */
const USER = "districell";
const REPO = "distribuidora";
const BRANCH = "main";
const FILE_PATH = "semilla.json";

/* Estado */
let DATA = [];
let CATS = {
  "Todas": 0,
  "Baterías": 0,
  "Cargadores": 50,
  "Módulos": 0,
  "Placas de Carga": 0,
  "Tapas Traseras": 0
};

/* Utils */
const el = id => document.getElementById(id);
function uid(){ return Date.now().toString(36)+Math.random().toString(36).slice(2,8); }
function fileToDataURL(f){ return new Promise((res,rej)=>{ if(!f) return res(null); const R=new FileReader(); R.onload=()=>res(R.result); R.onerror=rej; R.readAsDataURL(f); }); }
function formatCurrency(n){ return Number(n).toLocaleString('es-AR',{minimumFractionDigits:2}); }
function base64EncodeUtf8(str){return btoa(unescape(encodeURIComponent(str)));}

/* Precargados (lista completa de cargadores) */
const PRECARGADOS_CARGADORES = [
  {nombre:"CARGADOR 12V POTENCIADO MOD 36 - ONLY - POWERED - LIGHTNING - BLANCO", precio_base:2894.47},
  {nombre:"CARGADOR 12V POTENCIADO MOD 36 - ONLY - POWERED - LIGHTNING - NEGRO", precio_base:2894.47},
  {nombre:"Combo 1 CARGADOR 12V POTENCIADO MOD 36 - ONLY - POWERED - LIGHTNING", precio_base:23986.02},
  {nombre:"ADAPTADOR-CARGADOR 12V MOD 38 XAEA - SPEED - PD + QC 3.0", precio_base:5842.39},
  {nombre:"CARGADOR 12V BOOSTER MODS-500 - 2 USB + CABLE TIPO C - ONLY - BLANCO", precio_base:1289.82},
  {nombre:"CARGADOR 12V BOOSTER MODS-500 - 2 USB + CABLE TIPO C - ONLY - NEGRO", precio_base:1297.62},
  {nombre:"CARGADOR 12V DRIFT MODS-501 - 2 USB + CABLE TIPO C - ONLY - BLANCO", precio_base:2007.93},
  {nombre:"CARGADOR 12V DRIFT MODS-501 - 2 USB + CABLE TIPO C - ONLY - KIT X 200", precio_base:339693.88},
  {nombre:"CARGADOR 12V DRIFT MODS-501 - 2 USB + CABLE TIPO C - ONLY - NEGRO", precio_base:2007.93},
  {nombre:"CARGADOR 12V GEAR MODS-504 - 1 USB 1 TC + CABLE TIPO C - ONLY - NEGRO", precio_base:2009.89},
  {nombre:"CARGADOR 12V MOD 33 ECO 3.1 AMP - RIDE - ONLY - TIPO C", precio_base:2258.85},
  {nombre:"CARGADOR 12V POTENCIADO MOD 37 - ONLY - POWERED - TIPO C - NEGRO", precio_base:2747.01},
  {nombre:"CARGADOR 12V POTENCIADO MOD 37 - ONLY - POWERED -TIPO C - BLANCO", precio_base:2747.01},
  {nombre:"COMBO 2 - CARGADOR 12V POTENCIADO MOD 37 - ONLY - POWERED -TIPO C", precio_base:21842.04},
  {nombre:"COMBO 4 - CARGADOR 12V MOD 33 ECO 3.1 AMP - RIDE - ONLY - TIPO C", precio_base:21172.08},
  {nombre:"CARGADOR 12V MOD 33 ECO 3.1 AMP - RIDE - ONLY - V8", precio_base:2133.44},
  {nombre:"CARGADOR 12V MOD 40 - ONLY - BOOST- V8 - BLANCO", precio_base:1297.70},
  {nombre:"CARGADOR 12V POTENCIADO MOD 35 - ONLY - POWERED - V8 - NEGRO", precio_base:2590.17},
  {nombre:"CARGADOR 12V POTENCIADO MOD 35 - ONLY - POWERED - V8 - BLANCO", precio_base:2590.17},
  {nombre:"COMBO 3 - CARGADOR 12V POTENCIADO MOD 35 - ONLY - POWERED - V8", precio_base:21975.97},
  {nombre:"COMBO 5 - CARGADOR 12V MOD 33 ECO 3.1 AMP - RIDE - ONLY - V8", precio_base:21306.01},
  {nombre:"CARGADOR 220V MODO-006 - 2 USB + CABLE LIGHTNING - ONLY - BLANCO", precio_base:3559.77},
  {nombre:"CARGADOR 220V MODO-A015 INTENSIFY - 2USB + CABLE LIGHTNING - XAEA - BLANCO", precio_base:3473.33},
  {nombre:"CARGADOR 220V MODO-B015 INTENSIFY - 3USB + CABLE LIGHTNING - XAEA - BLANCO", precio_base:3429.76},
  {nombre:"CARGADOR 220V ONLY MOD 02 - 2 USB + CABLE LIGHTINING - BLANCO", precio_base:6362.78},
  {nombre:"CARGADOR 220V ONLY MOD 06 - 2 USB + CABLE LIGHTNING - BLANCO", precio_base:3501.43},
  {nombre:"CARGADOR 220V LETS MOD08 - 4,4 A - 3 USB + CABLE TIPO C - BLANCO", precio_base:2679.29},
  {nombre:"CARGADOR 220V LETS MOD08 - 4,4A - 2 USB + CABLE TIPO C - BLANCO", precio_base:2881.07},
  {nombre:"CARGADOR 220V MODO-006 - 1USB + TIPO C - ONLY - NEGRO", precio_base:2808.01},
  {nombre:"CARGADOR 220V MODO-006 - 1USB + TIPO C - ONLY PREMIUM - BLANCO", precio_base:2722.91},
  {nombre:"CARGADOR 220V MODO-006 - 1USB + TIPO C BLANCO - ONLY - KIT X 200", precio_base:573065.18},
  {nombre:"CARGADOR 220V MODO-006 - 1USB + TIPO C NEGRO - ONLY - KIT X 200", precio_base:573065.18},
  {nombre:"CARGADOR 220V MODO-006 - 2USB + CABLE TC BLANCO - ONLY - KIT X 200", precio_base:595305.04},
  {nombre:"CARGADOR 220V MODO-006 - 2USB + CABLE TC NEGRO - ONLY - KIT X 200", precio_base:578148.50},
  {nombre:"CARGADOR 220V MODO-008 - 4,4A - 3USB + CABLE TIPO TC - ONLY", precio_base:3302.31},
  {nombre:"CARGADOR 220V MODO-008 BOOST - 4,4A - 3USB + CABLE TIPO C - ONLY - BLANCO", precio_base:3053.25},
  {nombre:"CARGADOR 220V MODO-018 4.8A - RUSH - 1USB + CABLE TIPO C - ONLY - BLANCO", precio_base:1941.50},
  {nombre:"CARGADOR 220V MODO-018 4.8A - RUSH - 1USB + CABLE TIPO C - ONLY - NEGRO", precio_base:1710.37},
  {nombre:"CARGADOR 220V MODO-040 IMPULSE - 2.1A + CABLE TIPO C - ONLY - BLANCO", precio_base:1813.06},
  {nombre:"CARGADOR 220V MODO-A015 INTENSIFY - 2USB + CABLE TIPO C - XAEA - BLANCO", precio_base:3098.88},
  {nombre:"CARGADOR 220V MODO-A015 INTENSIFY - 2USB + CABLE TIPO C - XAEA - BLANCO - KIT X 200", precio_base:566501.69},
  {nombre:"CARGADOR 220V MODO-B015 INTENSIFY - 3USB + CABLE TIPO C - XAEA", precio_base:3039.05},
  {nombre:"CARGADOR 220V MODO-B015 INTENSIFY - 3USB + CABLE TIPO C - XAEA - KIT X 200", precio_base:571578.12},
  {nombre:"CARGADOR 220V ONLY MOD 03 - 2,1 A - 1 USB + CABLE TIPO C - BLANCO", precio_base:2356.15},
  {nombre:"CARGADOR 220V ONLY MOD02 - 1 USB C/ CABLE TIPO C - BLANCO", precio_base:3107.03},
  {nombre:"CARGADOR 220V ONLY MOD06 - 2 USB + CABLE TC - BLANCO", precio_base:2841.71},
  {nombre:"CARGADOR 220V ONLY MOD06 - 2 USB + CABLE TC - NEGRO", precio_base:2852.15},
  {nombre:"CARGADOR 220V XAEA MOD 10 - 9V - 27W - 1 USB + CABLE TIPO C - BLANCO", precio_base:4701.41},
  {nombre:"CARGADOR 220V XAEA MOD 10 - 9V - 27W - 1 USB + CABLE TIPO C - BLANCO - KIT X 100", precio_base:405974.26}
];

/* Normalizar categoría: mapear variantes de cargadores a 'Cargadores' */
function normalizeCategoria(cat){
  if(!cat) return 'Todas';
  const s = cat.toString().trim();
  if(/cargador|cargadores|CARGADOR|CARGADORES|Cargadores_|Cargadores_/i.test(s)) return 'Cargadores';
  return s;
}

/* Construir categorías desde DATA sin borrar base */
function buildCatsFromData(){
  const base = {"Todas":0,"Baterías":0,"Cargadores":50,"Módulos":0,"Placas de Carga":0,"Tapas Traseras":0};
  Object.keys(CATS).forEach(k=>{ if(base[k]===undefined) base[k]=CATS[k]; else base[k] = (CATS[k]!==undefined?CATS[k]:base[k]); });
  DATA.forEach(p=>{
    p.categoria = normalizeCategoria(p.categoria || '');
    if(base[p.categoria]===undefined) base[p.categoria] = (p.categoria==='Cargadores'?50:0);
  });
  CATS = base;
}

/* render categorías */
function drawCats(){
  const cont = el('cats'); cont.innerHTML = '';
  Object.keys(CATS).sort((a,b)=>{
    if(a==='Todas') return -1;
    if(b==='Todas') return 1;
    if(a==='Cargadores') return -1;
    if(b==='Cargadores') return 1;
    return a.localeCompare(b,'es');
  }).forEach(c=>{
    const box = document.createElement('div'); box.className='cat-box';
    box.innerHTML = `<strong>${c}</strong> <span style="margin-left:6px;color:#666">(${CATS[c]}%)</span>`;
    box.style.cursor='pointer';
    box.onclick = ()=> drawCategory(c);
    const editPct = document.createElement('button'); editPct.className='btn'; editPct.style.marginLeft='8px'; editPct.textContent='Editar %';
    editPct.onclick = (ev)=>{ ev.stopPropagation(); const val = prompt('Nuevo % para '+c, CATS[c]); if(val!==null){ CATS[c]=Number(val)||0; drawCats(); draw(); } };
    const delBtn = document.createElement('button'); delBtn.className='btn'; delBtn.style.marginLeft='8px'; delBtn.textContent='Eliminar';
    delBtn.onclick = async (ev)=>{ ev.stopPropagation(); if(c==='Cargadores' || c==='Todas'){ return alert('No se puede eliminar la categoría '+c); } if(!confirm('Eliminar categoría '+c+' y sus productos?')) return; DATA = DATA.filter(p=>p.categoria!==c); delete CATS[c]; drawCats(); draw(); await trySaveToGitHub(); };
    box.appendChild(editPct); box.appendChild(delBtn);
    cont.appendChild(box);
  });
}

/* dibujar productos */
function draw(q=''){
  const list = el('list'); list.innerHTML = '';
  const qq = (q || el('q').value || '').toLowerCase();
  const items = DATA.filter(p=> (qq==='' || (p.nombre||'').toLowerCase().includes(qq)));
  if(items.length===0){ list.innerHTML = '<div class="card small">No hay productos para mostrar.</div>'; return; }
  items.forEach(p=>{
    const card = document.createElement('div'); card.className='card';
    const markup = CATS[p.categoria]||0;
    const base = (p.precio_base!==undefined?Number(p.precio_base):Number(p.precio_final||0))||0;
    const finalP = base * (1 + markup/100);
    const imgHtml = p.imagen?`<img src="${p.imagen}">`:'Sin imagen';
    card.innerHTML = `<div class="preview">${imgHtml}</div>
      <b>${p.nombre||''}</b>
      <div class="small">${p.categoria||''}</div>
      <div style="margin-top:6px;font-weight:600">$ ${formatCurrency(finalP)}</div>`;
    const btn = document.createElement('button'); btn.className='btn'; btn.style.marginTop='6px'; btn.textContent='Editar';
    btn.onclick = ()=> openModal(p.id);
    const del = document.createElement('button'); del.className='btn'; del.style.background='#c0392b'; del.style.marginLeft='8px'; del.textContent='Borrar';
    del.onclick = async ()=>{ if(!confirm('Eliminar este producto?')) return; DATA = DATA.filter(x=>x.id!==p.id); draw(); drawCats(); await trySaveToGitHub(); };
    const row = document.createElement('div'); row.style.marginTop='8px';
    row.appendChild(btn); row.appendChild(del);
    card.appendChild(row);
    list.appendChild(card);
  });
}

/* drawCategory */
function drawCategory(cat){
  const list = el('list'); list.innerHTML = '';
  const items = DATA.filter(p=>p.categoria === cat);
  if(items.length===0){ list.innerHTML = '<div class="card small">No hay productos en esta categoría.</div>'; return; }
  items.forEach(p=>{
    const card = document.createElement('div'); card.className='card';
    const markup = CATS[p.categoria]||0;
    const base = (p.precio_base!==undefined?Number(p.precio_base):Number(p.precio_final||0))||0;
    const finalP = base * (1 + markup/100);
    const imgHtml = p.imagen?`<img src="${p.imagen}">`:'Sin imagen';
    card.innerHTML = `<div class="preview">${imgHtml}</div>
      <b>${p.nombre||''}</b>
      <div class="small">${p.categoria||''}</div>
      <div style="margin-top:6px;font-weight:600">$ ${formatCurrency(finalP)}</div>`;
    const btn = document.createElement('button'); btn.className='btn'; btn.style.marginTop='6px'; btn.textContent='Editar';
    btn.onclick = ()=> openModal(p.id);
    const del = document.createElement('button'); del.className='btn'; del.style.background='#c0392b'; del.style.marginLeft='8px'; del.textContent='Borrar';
    del.onclick = async ()=>{ if(!confirm('Eliminar este producto?')) return; DATA = DATA.filter(x=>x.id!==p.id); drawCategory(cat); drawCats(); populateCategories(); await trySaveToGitHub(); };
    const row = document.createElement('div'); row.style.marginTop='8px';
    row.appendChild(btn); row.appendChild(del);
    card.appendChild(row);
    list.appendChild(card);
  });
}

/* modal open/close y llenar select */
function openModal(id){
  const p = DATA.find(x=>x.id==id);
  el('modalTitle').textContent = p ? 'Editar producto' : 'Nuevo producto';
  if(p){
    el('pId').value = p.id;
    el('pNombre').value = p.nombre||'';
    el('pPrecio').value = p.precio_base!==undefined? p.precio_base : (p.precio_final||0);
    el('pCat').value = p.categoria||'Cargadores';
    el('pSpecs').value = p.caracteristicas||'';
    el('pStock').value = p.stock||'';
    el('pPreview').innerHTML = p.imagen ? `<img src="${p.imagen}">` : 'Sin imagen';
    el('deleteProduct').style.display = 'inline-block';
  } else {
    el('pId').value=''; el('pNombre').value=''; el('pPrecio').value=''; el('pCat').value='Cargadores';
    el('pSpecs').value=''; el('pStock').value=''; el('pPreview').textContent='Sin imagen';
    el('deleteProduct').style.display = 'none';
  }
  fillCatSelect();
  el('modalBg').style.display = 'flex';
}
function closeModal(){ el('modalBg').style.display = 'none'; }
function fillCatSelect(){
  const sel = el('pCat'); sel.innerHTML = '';
  Object.keys(CATS).forEach(cat=>{
    const opt = document.createElement('option'); opt.value = cat; opt.textContent = cat;
    sel.appendChild(opt);
  });
}

/* cargar semilla y precargar cargadores */
async function loadSeed(){
  try{
    const r = await fetch(FILE_PATH+'?v='+Date.now());
    if(r.ok){
      const j = await r.json();
      if(Array.isArray(j)) DATA = j.map(p=>normalizeProductFromSeed(p));
      else if(j.DATA) DATA = (j.DATA||[]).map(p=>normalizeProductFromSeed(p));
    }
  }catch(e){ /* ignore */ }
  buildCatsFromData();
  PRECARGADOS_CARGADORES.forEach(item=>{
    const exists = DATA.some(p=>p.nombre===item.nombre && p.categoria==='Cargadores');
    if(!exists){
      DATA.push({ id: uid(), nombre: item.nombre, categoria: 'Cargadores', precio_base: item.precio_base, imagen:'', caracteristicas:'', stock:'' });
    }
  });
  if(CATS['Cargadores']===undefined) CATS['Cargadores'] = 50;
  drawCats();
  draw();
}
function normalizeProductFromSeed(p){
  const prod = Object.assign({},p);
  prod.nombre = (prod.nombre||'').toString().trim();
  prod.categoria = normalizeCategoria(prod.categoria||'');
  prod.precio_base = prod.precio_base!==undefined ? Number(prod.precio_base) : (prod.precio_final!==undefined ? Number(prod.precio_final) : 0);
  prod.imagen = prod.imagen || '';
  prod.caracteristicas = prod.caracteristicas || '';
  prod.stock = prod.stock || '';
  prod.id = prod.id || uid();
  return prod;
}

/* Guardado en GitHub si token */
async function trySaveToGitHub(){
  const token = localStorage.getItem("gh_token");
  if(!token) return;
  try{
    const api = `https://api.github.com/repos/${USER}/${REPO}/contents/${FILE_PATH}`;
    let sha = null;
    const getRes = await fetch(api,{headers:{Authorization:`Bearer ${token}`}});
    if(getRes.status===200){ sha = (await getRes.json()).sha; }
    const body = { message: "Actualizar semilla.json", content: base64EncodeUtf8(JSON.stringify(DATA,null,2)), branch: BRANCH };
    if(sha) body.sha = sha;
    const putRes = await fetch(api, { method:'PUT', headers:{ Authorization:`Bearer ${token}` }, body: JSON.stringify(body) });
    if(!putRes.ok) alert("Error al guardar en GitHub");
  }catch(e){ console.warn('Error save GitHub', e); }
}

/* guardar producto */
el('save').addEventListener('click', async ()=>{
  const id = el('pId').value.trim();
  const nombre = el('pNombre').value.trim();
  const categoria = normalizeCategoria(el('pCat').value || 'Cargadores');
  const precio = Number(el('pPrecio').value || 0);
  const caracteristicas = el('pSpecs').value.trim();
  const stock = el('pStock')?el('pStock').value.trim():'';
  let imagen = '';
  const f = el('pImagen').files[0];
  if(f) imagen = await fileToDataURL(f);
  else {
    const prev = el('pPreview').querySelector('img');
    if(prev) imagen = prev.src;
  }
  if(!nombre) return alert('El producto necesita nombre');
  if(!categoria) return alert('Seleccioná categoría');
  if(id){
    const i = DATA.findIndex(x=>x.id==id);
    if(i>=0) DATA[i] = { ...DATA[i], nombre, categoria, precio_base:precio, caracteristicas, stock, imagen };
    else DATA.push({ id, nombre, categoria, precio_base:precio, caracteristicas, stock, imagen });
  } else {
    DATA.push({ id: uid(), nombre, categoria, precio_base:precio, caracteristicas, stock, imagen });
  }
  if(CATS[categoria]===undefined) CATS[categoria] = (categoria==='Cargadores'?50:0);
  buildCatsFromData();
  drawCats();
  draw();
  await trySaveToGitHub();
  closeModal();
});

/* eliminar desde modal */
el('deleteProduct').addEventListener('click', async ()=>{
  const id = el('pId').value.trim();
  if(!id) return alert('No hay producto seleccionado');
  if(!confirm('Eliminar este producto?')) return;
  DATA = DATA.filter(x=>x.id !== id);
  buildCatsFromData();
  drawCats();
  draw();
  await trySaveToGitHub();
  closeModal();
});

/* UI events */
el('closeModal').onclick = ()=> closeModal();
el('pImagen').addEventListener('change', async (e)=>{ const f = e.target.files[0]; if(!f) return; const r = await fileToDataURL(f); el('pPreview').innerHTML = `<img src="${r}">`; });
el('q').addEventListener('input', ()=> draw());
el('addProductBtn').addEventListener('click', ()=> { fillCatSelect(); openModal(null); });
el('addCat').addEventListener('click', ()=> {
  const v = (el('newCat').value||'').trim(); const m = Number(el('newMarkup').value||0);
  if(!v) return alert('Ingresá nombre de categoría');
  if(CATS[v]) return alert('La categoría ya existe');
  CATS[v] = m;
  drawCats();
  el('newCat').value=''; el('newMarkup').value='';
});
el('showAll').addEventListener('click', ()=> draw(''));

/* export/import */
el('exportBtn').addEventListener('click', ()=>{
  const payload = { DATA, CATS };
  const blob = new Blob([JSON.stringify(payload,null,2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'admin_export.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
});
el('importBtn').addEventListener('click', ()=> el('importFile').click());
el('importFile').addEventListener('change', async (e)=>{
  const f = e.target.files[0];
  if(!f) return;
  const txt = await f.text();
  try{
    const obj = JSON.parse(txt);
    if(Array.isArray(obj)) DATA = obj.map(p=>normalizeProductFromSeed(p));
    else if(obj.DATA && obj.CATS){ DATA = (obj.DATA||[]).map(p=>normalizeProductFromSeed(p)); CATS = obj.CATS || CATS; }
    else return alert('JSON no reconocido. Debe ser array o {DATA,CATS}.');
    buildCatsFromData();
    drawCats();
    draw();
    alert('Import OK');
  }catch(err){ alert('Error parse JSON: '+err.message); }
  e.target.value = null;
});

/* login/token/logout (ahora sin Demo visible) */
el('doLogin').addEventListener('click', ()=> {
  const email = el('email').value.trim(); const pass = el('pass').value.trim();
  if(email==='admin@celldistribuciones.com' && pass==='QWERTY123456'){
    el('loginBox').style.display='none';
    if(!localStorage.getItem("gh_token")) { el('tokenBox').style.display='block'; }
    else { el('app').style.display='block'; loadSeed(); }
  } else alert('Credenciales incorrectas');
});
el('saveToken').addEventListener('click', ()=> {
  const t = el('ghToken').value.trim();
  if(!t.startsWith('ghp_')) return alert('Token inválido');
  localStorage.setItem('gh_token', t);
  el('tokenBox').style.display='none';
  el('app').style.display='block';
  loadSeed();
});
el('logout').addEventListener('click', ()=> { localStorage.removeItem('gh_token'); location.reload(); });

/* Inicial: aseguramos categorías base */
["Todas","Baterías","Cargadores","Módulos","Placas de Carga","Tapas Traseras"].forEach(k=>{ if(CATS[k]===undefined) CATS[k]= (k==='Cargadores'?50:0); });
</script>
</body>
</html>
