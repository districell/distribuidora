
<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Admin • Cell Distribuciones</title>
<style>
:root{--max:1100px;--green:#2ecc71;--border:#e5e5e5}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:#fafafa;color:#111}
header{background:#111;color:#fff;padding:12px}
.wrap{max-width:var(--max);margin:0 auto;display:flex;align-items:center;justify-content:space-between}
.main{max-width:var(--max);margin:16px auto;padding:0 12px}
.panel{background:#fff;border:1px solid var(--border);border-radius:10px;padding:12px;margin-bottom:12px}
.btn{padding:8px 12px;border:none;border-radius:8px;background:#111;color:#fff;cursor:pointer}
.btn.green{background:#2ecc71}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px}
.card{border:1px solid var(--border);border-radius:10px;padding:10px;background:#fff}
.small{font-size:12px;color:#666}
.login{max-width:420px;margin:40px auto;padding:12px;background:#fff;border-radius:10px;border:1px solid var(--border)}
input,select,textarea{width:100%;padding:8px;border:1px solid var(--border);border-radius:8px}
.preview{height:150px;background:#f1f1f1;border-radius:8px;display:flex;align-items:center;justify-content:center;overflow:hidden}
.preview img{max-width:100%;max-height:100%}
.row{display:flex;gap:8px;flex-wrap:wrap}
</style>
</head>
<body>
<header><div class="wrap"><div>Admin • Cell Distribuciones</div><button id="logout" class="btn">Salir</button></div></header>
<main class="main">

  <!-- LOGIN -->
  <div id="loginBox" class="login">
    <h3>Ingresar</h3>
    <input id="email" placeholder="Email" autocomplete="off"><br><br>
    <input id="pass" placeholder="Contraseña" type="password" autocomplete="off"><br><br>
    <button id="doLogin" class="btn green">Entrar</button>
    <p class="small">Tras el login, si falta el token de GitHub te lo pedimos (queda guardado solo en este navegador).</p>
  </div>

  <!-- TOKEN -->
  <div id="tokenBox" class="login" style="display:none">
    <h3>Token de GitHub</h3>
    <p class="small">Pegá tu token con permiso <b>public_repo</b>. Se guarda localmente (no se publica).</p>
    <input id="ghToken" placeholder="ghp_xxx..." autocomplete="off"><br><br>
    <button id="saveToken" class="btn green">Guardar Token</button>
  </div>

  <!-- APP -->
  <div id="app" style="display:none">
    <div class="panel">
      <h3>Categorías</h3>
      <div class="row">
        <input id="newCat" placeholder="Nueva categoría">
        <button id="addCat" class="btn">Agregar</button>
      </div>
      <div id="cats" class="row small" style="margin-top:8px"></div>
    </div>

    <div class="panel">
      <h3>Producto</h3>
      <div class="row" style="grid-template-columns:1fr 1fr;display:grid">
        <input id="pId" placeholder="ID (vacío = nuevo)">
        <input id="pNombre" placeholder="Nombre">
        <input id="pCat" placeholder="Categoría">
        <input id="pPrecio" placeholder="Precio final" type="number" step="0.01">
        <input id="pImagen" type="file" accept="image/*">
        <div id="pPreview" class="preview">Sin imagen</div>
        <textarea id="pSpecs" placeholder="Características" rows="4"></textarea>
      </div>
      <div style="margin-top:8px">
        <button id="save" class="btn green">Guardar</button>
        <button id="del" class="btn" style="background:#c0392b">Eliminar</button>
      </div>
    </div>

    <div class="panel">
      <h3>Productos</h3>
      <input id="q" placeholder="Buscar...">
      <div id="list" class="grid" style="margin-top:10px"></div>
    </div>
  </div>

</main>

<script>
/* === CONFIG === */
const USER = "districell";
const REPO = "distribuidora";
const BRANCH = "main";
const FILE_PATH = "semilla.json";

/* === STATE === */
let DATA = [];

/* === HELPERS === */
function base64EncodeUtf8(str){
  return btoa(unescape(encodeURIComponent(str)));
}
function fileToDataURL(f){
  return new Promise((res,rej)=>{
    const R=new FileReader(); R.onload=()=>res(R.result); R.onerror=rej; R.readAsDataURL(f);
  });
}

/* === LOAD SEED === */
async function loadSeed(){
  try{
    const r = await fetch(FILE_PATH+'?v='+Date.now());
    const d = await r.json();
    DATA = Array.isArray(d)? d : [];
  }catch(e){ DATA = []; }
  draw(); drawCats();
}

/* === SAVE TO GITHUB === */
async function saveToGitHub(content){
  const token = localStorage.getItem("gh_token");
  if(!token){ alert("Token de GitHub no configurado."); return; }

  const api = `https://api.github.com/repos/${USER}/${REPO}/contents/${FILE_PATH}`;
  let sha = null;

  // 1) Leer SHA si existe
  const getRes = await fetch(api, {
    method: "GET",
    headers: { "Authorization": `Bearer ${token}`, "Accept":"application/vnd.github+json" }
  });
  if(getRes.status === 200){
    const fileData = await getRes.json();
    sha = fileData.sha;
  }else if(getRes.status !== 404){
    const t = await getRes.text();
    alert("Error leyendo archivo en GitHub: " + t);
    return;
  }

  // 2) Subir PUT (crear o actualizar)
  const body = {
    message: "Actualizar semilla.json desde admin",
    content: base64EncodeUtf8(content),
    branch: BRANCH
  };
  if(sha) body.sha = sha;

  const putRes = await fetch(api, {
    method: "PUT",
    headers: { "Authorization": `Bearer ${token}`, "Accept":"application/vnd.github+json" },
    body: JSON.stringify(body)
  });

  if(!putRes.ok){
    const t = await putRes.text();
    alert("Error al guardar en GitHub: " + t);
    return;
  }
  alert("✅ Guardado en GitHub. Cambios visibles en 1–2 min.");
}

/* === UI === */
function drawCats(){
  const cats = Array.from(new Set(DATA.map(p=>p.categoria).filter(Boolean))).sort();
  const cont = document.getElementById('cats'); cont.innerHTML='';
  cats.forEach(c=>{
    const box = document.createElement('div'); box.textContent = c + ' ';
    const btn = document.createElement('button'); btn.className='btn'; btn.textContent='Eliminar';
    btn.onclick = ()=>{ DATA = DATA.filter(p=>p.categoria!==c); draw(); drawCats(); };
    box.appendChild(btn); cont.appendChild(box);
  });
  document.getElementById('addCat').onclick = ()=>{
    const v = document.getElementById('newCat').value.trim(); if(!v) return;
    DATA.push({id: Date.now().toString(), nombre:'Nuevo producto', categoria:v, precio_final:0, caracteristicas:'', imagen:''});
    draw(); drawCats();
  };
}

function draw(q=''){
  const list = document.getElementById('list'); list.innerHTML='';
  DATA.filter(p=> !q || (p.nombre||'').toLowerCase().includes(q.toLowerCase()))
      .forEach(p=>{
        const card = document.createElement('div'); card.className='card';
        card.innerHTML = '<div class="preview">'+(p.imagen?('<img src="'+p.imagen+'">'):'Sin imagen')+'</div>'+
          '<b>'+ (p.nombre||'') +'</b><div class="small">'+(p.categoria||'')+'</div><div>$'+Number(p.precio_final||p.precio||0).toLocaleString('es-AR',{minimumFractionDigits:2})+'</div>';
        const btn = document.createElement('button'); btn.className='btn'; btn.style.marginTop='6px'; btn.textContent='Editar';
        btn.onclick = ()=> fillForm(p.id);
        card.appendChild(btn); list.appendChild(card);
      });
}

function fillForm(id){
  const p = DATA.find(x=>x.id==id); if(!p) return;
  pId.value = p.id; pNombre.value = p.nombre||''; pCat.value = p.categoria||'';
  pPrecio.value = p.precio_final || p.precio || 0; pSpecs.value = p.caracteristicas||'';
  if(p.imagen){ pPreview.innerHTML = '<img src="'+p.imagen+'">'; } else { pPreview.textContent='Sin imagen'; }
}

/* === EVENTS === */
document.getElementById('pImagen').addEventListener('change', async (e)=>{
  const f = e.target.files[0]; if(!f) return;
  const r = await fileToDataURL(f);
  pPreview.innerHTML = '<img src="'+r+'">';
});

document.getElementById('save').onclick = async ()=>{
  let id = pId.value.trim(); const nombre = pNombre.value.trim(); const categoria = pCat.value.trim();
  const precio = Number(pPrecio.value||0); const caracteristicas = pSpecs.value.trim();
  let imagen = ''; const f = pImagen.files[0];
  if(f){ imagen = await fileToDataURL(f); } else if(pPreview.querySelector('img')){ imagen = pPreview.querySelector('img').src; }

  if(id){
    const i = DATA.findIndex(x=>x.id==id);
    if(i>=0){ DATA[i] = {...DATA[i], nombre, categoria, precio_final:precio, caracteristicas, imagen: imagen || DATA[i].imagen || ''}; }
    else { DATA.push({id,nombre,categoria,precio_final:precio,caracteristicas,imagen}); }
  } else {
    id = Date.now().toString();
    DATA.push({id,nombre,categoria,precio_final:precio,caracteristicas,imagen});
  }
  draw(); drawCats();
  await saveToGitHub(JSON.stringify(DATA,null,2));
};

document.getElementById('del').onclick = async ()=>{
  const id = pId.value.trim(); if(!id) return alert('Ingresá ID');
  DATA = DATA.filter(x=>x.id!=id); draw(); drawCats();
  await saveToGitHub(JSON.stringify(DATA,null,2));
};

document.getElementById('q').addEventListener('input', e=> draw(e.target.value));

/* === LOGIN === */
document.getElementById('doLogin').onclick = ()=>{
  if(email.value==='admin@celldistribuciones.com' && pass.value==='QWERTY123456'){
    loginBox.style.display='none';
    if(!localStorage.getItem("gh_token")) tokenBox.style.display='block';
    else { app.style.display='block'; loadSeed(); }
  } else {
    alert('Credenciales incorrectas');
  }
};
document.getElementById('saveToken').onclick = ()=>{
  const t = ghToken.value.trim();
  if(!t.startsWith("ghp_")) return alert("Token inválido");
  localStorage.setItem("gh_token", t);
  tokenBox.style.display='none';
  app.style.display='block';
  loadSeed();
};
document.getElementById('logout').onclick = ()=>{
  localStorage.removeItem("gh_token");
  location.reload();
};

/* === AUTO === */
</script>
</body>
</html>
